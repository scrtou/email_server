<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chrome存储调试</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #f5f5f5;
    }
    .section {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border-left: 4px solid #4285f4;
    }
    button {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background: #4285f4;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #3367d6;
    }
    input {
      padding: 8px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 300px;
    }
    #output {
      background: #000;
      color: #0f0;
      padding: 10px;
      border-radius: 4px;
      height: 300px;
      overflow-y: auto;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .error {
      color: #f00;
    }
    .success {
      color: #0f0;
    }
    .warning {
      color: #ff0;
    }
  </style>
</head>
<body>
  <h1>🔧 Chrome存储调试工具</h1>
  
  <div class="section">
    <h3>环境检查</h3>
    <div id="env-check">检查中...</div>
  </div>
  
  <div class="section">
    <h3>存储操作</h3>
    <input type="url" id="server-url" placeholder="https://accountback.azhen.de" value="https://accountback.azhen.de">
    <button onclick="testSaveConfig()">保存配置</button>
    <button onclick="testLoadConfig()">加载配置</button>
    <button onclick="testClearConfig()">清空配置</button>
  </div>
  
  <div class="section">
    <h3>Background Script测试</h3>
    <button onclick="testBackgroundMessage()">测试Background消息</button>
    <button onclick="testLoginMessage()">测试登录消息</button>
  </div>
  
  <div class="section">
    <h3>输出日志</h3>
    <div id="output"></div>
    <button onclick="clearOutput()">清空日志</button>
  </div>

  <script>
    let output;
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logLine = `[${timestamp}] ${message}\n`;
      console.log(message);
      
      if (output) {
        const span = document.createElement('span');
        span.className = type;
        span.textContent = logLine;
        output.appendChild(span);
        output.scrollTop = output.scrollHeight;
      }
    }
    
    function clearOutput() {
      if (output) {
        output.innerHTML = '';
      }
    }
    
    function checkEnvironment() {
      const envDiv = document.getElementById('env-check');
      let html = '';
      
      // 检查Chrome API
      html += `<p><strong>chrome对象:</strong> ${typeof chrome}</p>`;
      html += `<p><strong>chrome.storage:</strong> ${typeof chrome?.storage}</p>`;
      html += `<p><strong>chrome.storage.sync:</strong> ${typeof chrome?.storage?.sync}</p>`;
      html += `<p><strong>chrome.runtime:</strong> ${typeof chrome?.runtime}</p>`;
      html += `<p><strong>chrome.runtime.sendMessage:</strong> ${typeof chrome?.runtime?.sendMessage}</p>`;
      
      // 检查扩展环境
      const isExtension = chrome && chrome.runtime && chrome.runtime.id;
      html += `<p><strong>扩展环境:</strong> ${isExtension ? '✅ 是' : '❌ 否'}</p>`;
      
      if (isExtension) {
        html += `<p><strong>扩展ID:</strong> ${chrome.runtime.id}</p>`;
      }
      
      envDiv.innerHTML = html;
      
      if (!isExtension) {
        log('❌ 不在扩展环境中，某些功能可能无法正常工作', 'error');
      } else {
        log('✅ 扩展环境检查通过', 'success');
      }
    }
    
    function testSaveConfig() {
      const serverURL = document.getElementById('server-url').value;
      
      if (!serverURL) {
        log('❌ 请输入服务器地址', 'error');
        return;
      }
      
      log(`💾 保存配置: ${serverURL}`, 'info');
      
      if (!chrome || !chrome.storage) {
        log('❌ Chrome存储API不可用', 'error');
        return;
      }
      
      const config = { serverURL };
      
      chrome.storage.sync.set(config, () => {
        if (chrome.runtime.lastError) {
          log(`❌ 保存失败: ${chrome.runtime.lastError.message}`, 'error');
        } else {
          log('✅ 配置保存成功', 'success');
          testLoadConfig(); // 立即验证
        }
      });
    }
    
    function testLoadConfig() {
      log('📦 加载配置...', 'info');
      
      if (!chrome || !chrome.storage) {
        log('❌ Chrome存储API不可用', 'error');
        return;
      }
      
      chrome.storage.sync.get(['serverURL', 'token', 'username', 'password'], (result) => {
        if (chrome.runtime.lastError) {
          log(`❌ 加载失败: ${chrome.runtime.lastError.message}`, 'error');
        } else {
          log(`📋 配置内容: ${JSON.stringify(result, null, 2)}`, 'success');
          
          if (Object.keys(result).length === 0) {
            log('⚠️ 未找到任何配置', 'warning');
          }
        }
      });
    }
    
    function testClearConfig() {
      log('🗑️ 清空配置...', 'info');
      
      if (!chrome || !chrome.storage) {
        log('❌ Chrome存储API不可用', 'error');
        return;
      }
      
      chrome.storage.sync.clear(() => {
        if (chrome.runtime.lastError) {
          log(`❌ 清空失败: ${chrome.runtime.lastError.message}`, 'error');
        } else {
          log('✅ 配置已清空', 'success');
        }
      });
    }
    
    function testBackgroundMessage() {
      log('📨 测试Background消息...', 'info');
      
      if (!chrome || !chrome.runtime) {
        log('❌ Chrome runtime API不可用', 'error');
        return;
      }
      
      chrome.runtime.sendMessage({ action: 'getConfig' }, (response) => {
        if (chrome.runtime.lastError) {
          log(`❌ 消息发送失败: ${chrome.runtime.lastError.message}`, 'error');
        } else {
          log(`📋 Background响应: ${JSON.stringify(response, null, 2)}`, 'success');
        }
      });
    }
    
    function testLoginMessage() {
      log('🔐 测试登录消息...', 'info');
      
      if (!chrome || !chrome.runtime) {
        log('❌ Chrome runtime API不可用', 'error');
        return;
      }
      
      chrome.runtime.sendMessage({
        action: 'login',
        username: 'test',
        password: 'test'
      }, (response) => {
        if (chrome.runtime.lastError) {
          log(`❌ 登录消息发送失败: ${chrome.runtime.lastError.message}`, 'error');
        } else {
          log(`🔐 登录响应: ${JSON.stringify(response, null, 2)}`, response.success ? 'success' : 'error');
        }
      });
    }
    
    // 页面初始化
    document.addEventListener('DOMContentLoaded', () => {
      output = document.getElementById('output');
      log('🚀 Chrome存储调试工具初始化', 'info');
      
      checkEnvironment();
      
      // 自动加载当前配置
      setTimeout(() => {
        testLoadConfig();
      }, 500);
    });
  </script>
</body>
</html>
