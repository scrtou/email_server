<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Chromeå­˜å‚¨è°ƒè¯•</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #f5f5f5;
    }
    .section {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border-left: 4px solid #4285f4;
    }
    button {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background: #4285f4;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #3367d6;
    }
    input {
      padding: 8px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 300px;
    }
    #output {
      background: #000;
      color: #0f0;
      padding: 10px;
      border-radius: 4px;
      height: 300px;
      overflow-y: auto;
      font-size: 12px;
      white-space: pre-wrap;
    }
    .error {
      color: #f00;
    }
    .success {
      color: #0f0;
    }
    .warning {
      color: #ff0;
    }
  </style>
</head>
<body>
  <h1>ğŸ”§ Chromeå­˜å‚¨è°ƒè¯•å·¥å…·</h1>
  
  <div class="section">
    <h3>ç¯å¢ƒæ£€æŸ¥</h3>
    <div id="env-check">æ£€æŸ¥ä¸­...</div>
  </div>
  
  <div class="section">
    <h3>å­˜å‚¨æ“ä½œ</h3>
    <input type="url" id="server-url" placeholder="https://accountback.azhen.de" value="https://accountback.azhen.de">
    <button onclick="testSaveConfig()">ä¿å­˜é…ç½®</button>
    <button onclick="testLoadConfig()">åŠ è½½é…ç½®</button>
    <button onclick="testClearConfig()">æ¸…ç©ºé…ç½®</button>
  </div>
  
  <div class="section">
    <h3>Background Scriptæµ‹è¯•</h3>
    <button onclick="testBackgroundMessage()">æµ‹è¯•Backgroundæ¶ˆæ¯</button>
    <button onclick="testLoginMessage()">æµ‹è¯•ç™»å½•æ¶ˆæ¯</button>
  </div>
  
  <div class="section">
    <h3>è¾“å‡ºæ—¥å¿—</h3>
    <div id="output"></div>
    <button onclick="clearOutput()">æ¸…ç©ºæ—¥å¿—</button>
  </div>

  <script>
    let output;
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logLine = `[${timestamp}] ${message}\n`;
      console.log(message);
      
      if (output) {
        const span = document.createElement('span');
        span.className = type;
        span.textContent = logLine;
        output.appendChild(span);
        output.scrollTop = output.scrollHeight;
      }
    }
    
    function clearOutput() {
      if (output) {
        output.innerHTML = '';
      }
    }
    
    function checkEnvironment() {
      const envDiv = document.getElementById('env-check');
      let html = '';
      
      // æ£€æŸ¥Chrome API
      html += `<p><strong>chromeå¯¹è±¡:</strong> ${typeof chrome}</p>`;
      html += `<p><strong>chrome.storage:</strong> ${typeof chrome?.storage}</p>`;
      html += `<p><strong>chrome.storage.sync:</strong> ${typeof chrome?.storage?.sync}</p>`;
      html += `<p><strong>chrome.runtime:</strong> ${typeof chrome?.runtime}</p>`;
      html += `<p><strong>chrome.runtime.sendMessage:</strong> ${typeof chrome?.runtime?.sendMessage}</p>`;
      
      // æ£€æŸ¥æ‰©å±•ç¯å¢ƒ
      const isExtension = chrome && chrome.runtime && chrome.runtime.id;
      html += `<p><strong>æ‰©å±•ç¯å¢ƒ:</strong> ${isExtension ? 'âœ… æ˜¯' : 'âŒ å¦'}</p>`;
      
      if (isExtension) {
        html += `<p><strong>æ‰©å±•ID:</strong> ${chrome.runtime.id}</p>`;
      }
      
      envDiv.innerHTML = html;
      
      if (!isExtension) {
        log('âŒ ä¸åœ¨æ‰©å±•ç¯å¢ƒä¸­ï¼ŒæŸäº›åŠŸèƒ½å¯èƒ½æ— æ³•æ­£å¸¸å·¥ä½œ', 'error');
      } else {
        log('âœ… æ‰©å±•ç¯å¢ƒæ£€æŸ¥é€šè¿‡', 'success');
      }
    }
    
    function testSaveConfig() {
      const serverURL = document.getElementById('server-url').value;
      
      if (!serverURL) {
        log('âŒ è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€', 'error');
        return;
      }
      
      log(`ğŸ’¾ ä¿å­˜é…ç½®: ${serverURL}`, 'info');
      
      if (!chrome || !chrome.storage) {
        log('âŒ Chromeå­˜å‚¨APIä¸å¯ç”¨', 'error');
        return;
      }
      
      const config = { serverURL };
      
      chrome.storage.sync.set(config, () => {
        if (chrome.runtime.lastError) {
          log(`âŒ ä¿å­˜å¤±è´¥: ${chrome.runtime.lastError.message}`, 'error');
        } else {
          log('âœ… é…ç½®ä¿å­˜æˆåŠŸ', 'success');
          testLoadConfig(); // ç«‹å³éªŒè¯
        }
      });
    }
    
    function testLoadConfig() {
      log('ğŸ“¦ åŠ è½½é…ç½®...', 'info');
      
      if (!chrome || !chrome.storage) {
        log('âŒ Chromeå­˜å‚¨APIä¸å¯ç”¨', 'error');
        return;
      }
      
      chrome.storage.sync.get(['serverURL', 'token', 'username', 'password'], (result) => {
        if (chrome.runtime.lastError) {
          log(`âŒ åŠ è½½å¤±è´¥: ${chrome.runtime.lastError.message}`, 'error');
        } else {
          log(`ğŸ“‹ é…ç½®å†…å®¹: ${JSON.stringify(result, null, 2)}`, 'success');
          
          if (Object.keys(result).length === 0) {
            log('âš ï¸ æœªæ‰¾åˆ°ä»»ä½•é…ç½®', 'warning');
          }
        }
      });
    }
    
    function testClearConfig() {
      log('ğŸ—‘ï¸ æ¸…ç©ºé…ç½®...', 'info');
      
      if (!chrome || !chrome.storage) {
        log('âŒ Chromeå­˜å‚¨APIä¸å¯ç”¨', 'error');
        return;
      }
      
      chrome.storage.sync.clear(() => {
        if (chrome.runtime.lastError) {
          log(`âŒ æ¸…ç©ºå¤±è´¥: ${chrome.runtime.lastError.message}`, 'error');
        } else {
          log('âœ… é…ç½®å·²æ¸…ç©º', 'success');
        }
      });
    }
    
    function testBackgroundMessage() {
      log('ğŸ“¨ æµ‹è¯•Backgroundæ¶ˆæ¯...', 'info');
      
      if (!chrome || !chrome.runtime) {
        log('âŒ Chrome runtime APIä¸å¯ç”¨', 'error');
        return;
      }
      
      chrome.runtime.sendMessage({ action: 'getConfig' }, (response) => {
        if (chrome.runtime.lastError) {
          log(`âŒ æ¶ˆæ¯å‘é€å¤±è´¥: ${chrome.runtime.lastError.message}`, 'error');
        } else {
          log(`ğŸ“‹ Backgroundå“åº”: ${JSON.stringify(response, null, 2)}`, 'success');
        }
      });
    }
    
    function testLoginMessage() {
      log('ğŸ” æµ‹è¯•ç™»å½•æ¶ˆæ¯...', 'info');
      
      if (!chrome || !chrome.runtime) {
        log('âŒ Chrome runtime APIä¸å¯ç”¨', 'error');
        return;
      }
      
      chrome.runtime.sendMessage({
        action: 'login',
        username: 'test',
        password: 'test'
      }, (response) => {
        if (chrome.runtime.lastError) {
          log(`âŒ ç™»å½•æ¶ˆæ¯å‘é€å¤±è´¥: ${chrome.runtime.lastError.message}`, 'error');
        } else {
          log(`ğŸ” ç™»å½•å“åº”: ${JSON.stringify(response, null, 2)}`, response.success ? 'success' : 'error');
        }
      });
    }
    
    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      output = document.getElementById('output');
      log('ğŸš€ Chromeå­˜å‚¨è°ƒè¯•å·¥å…·åˆå§‹åŒ–', 'info');
      
      checkEnvironment();
      
      // è‡ªåŠ¨åŠ è½½å½“å‰é…ç½®
      setTimeout(() => {
        testLoadConfig();
      }, 500);
    });
  </script>
</body>
</html>
