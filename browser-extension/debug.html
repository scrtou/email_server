<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>è°ƒè¯•é¡µé¢</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #f5f5f5;
    }
    .debug-section {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border-left: 4px solid #4285f4;
    }
    .error { border-left-color: #d93025; }
    .success { border-left-color: #34a853; }
    .warning { border-left-color: #fbbc04; }
    button {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background: #4285f4;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #3367d6;
    }
    #log {
      background: #000;
      color: #0f0;
      padding: 10px;
      border-radius: 4px;
      height: 200px;
      overflow-y: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>ğŸ”§ å¯†ç åº“æ’ä»¶è°ƒè¯•é¡µé¢</h1>
  
  <div class="debug-section">
    <h3>Chrome API çŠ¶æ€æ£€æŸ¥</h3>
    <div id="chrome-status">æ£€æŸ¥ä¸­...</div>
  </div>
  
  <div class="debug-section">
    <h3>DOM å…ƒç´ æ£€æŸ¥</h3>
    <div id="dom-status">æ£€æŸ¥ä¸­...</div>
  </div>
  
  <div class="debug-section">
    <h3>åŠŸèƒ½æµ‹è¯•</h3>
    <button onclick="testSettingsButton()">æµ‹è¯•è®¾ç½®æŒ‰é’®</button>
    <button onclick="testChromeAPI()">æµ‹è¯•Chrome API</button>
    <button onclick="loadPopupContent()">åŠ è½½Popupå†…å®¹</button>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
  </div>
  
  <div class="debug-section">
    <h3>å®æ—¶æ—¥å¿—</h3>
    <div id="log"></div>
  </div>

  <script>
    let logElement;
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logLine = `[${timestamp}] ${message}`;
      console.log(logLine);
      
      if (logElement) {
        const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : type === 'warning' ? '#ff0' : '#0f0';
        logElement.innerHTML += `<div style="color: ${color}">${logLine}</div>`;
        logElement.scrollTop = logElement.scrollHeight;
      }
    }
    
    function clearLog() {
      if (logElement) {
        logElement.innerHTML = '';
      }
    }
    
    // è®¾ç½®Chrome APIæ¨¡æ‹Ÿ
    function setupChromeAPI() {
      if (typeof chrome === 'undefined' || !chrome.runtime) {
        log('è®¾ç½®Chrome APIæ¨¡æ‹Ÿ...', 'warning');
        window.chrome = {
          runtime: {
            sendMessage: function(message, callback) {
              log(`æ¨¡æ‹Ÿæ¶ˆæ¯: ${JSON.stringify(message)}`, 'info');
              setTimeout(() => {
                if (message.action === 'getConfig') {
                  callback({ token: null });
                } else if (message.action === 'login') {
                  callback({ success: true });
                } else {
                  callback({ success: false, error: 'æœªçŸ¥æ“ä½œ' });
                }
              }, 300);
            },
            openOptionsPage: function() {
              log('âœ… è®¾ç½®æŒ‰é’®åŠŸèƒ½æ­£å¸¸ï¼', 'success');
              alert('âœ… è®¾ç½®æŒ‰é’®å·¥ä½œæ­£å¸¸ï¼\n\nåœ¨çœŸå®çš„æ‰©å±•ç¯å¢ƒä¸­ï¼Œè¿™é‡Œä¼šæ‰“å¼€æ‰©å±•çš„è®¾ç½®é¡µé¢ã€‚');
            }
          },
          tabs: {
            query: function(queryInfo, callback) {
              setTimeout(() => {
                callback([{
                  url: 'https://example.com',
                  title: 'ç¤ºä¾‹ç½‘ç«™'
                }]);
              }, 100);
            }
          }
        };
        log('Chrome APIæ¨¡æ‹Ÿè®¾ç½®å®Œæˆ', 'success');
      } else {
        log('æ£€æµ‹åˆ°çœŸå®Chrome API', 'success');
      }
    }
    
    function checkChromeAPI() {
      const status = document.getElementById('chrome-status');
      let html = '';
      
      html += `<p><strong>chromeå¯¹è±¡:</strong> ${typeof chrome}</p>`;
      html += `<p><strong>chrome.runtime:</strong> ${typeof chrome?.runtime}</p>`;
      html += `<p><strong>chrome.runtime.sendMessage:</strong> ${typeof chrome?.runtime?.sendMessage}</p>`;
      html += `<p><strong>chrome.runtime.openOptionsPage:</strong> ${typeof chrome?.runtime?.openOptionsPage}</p>`;
      html += `<p><strong>chrome.tabs:</strong> ${typeof chrome?.tabs}</p>`;
      
      status.innerHTML = html;
      
      if (chrome && chrome.runtime && chrome.runtime.openOptionsPage) {
        status.className = 'debug-section success';
      } else {
        status.className = 'debug-section error';
      }
    }
    
    function checkDOMElements() {
      const status = document.getElementById('dom-status');
      const elements = [
        'settings-btn',
        'login-form', 
        'add-btn',
        'search-input',
        'type-filter'
      ];
      
      let html = '';
      let allFound = true;
      
      elements.forEach(id => {
        const element = document.getElementById(id);
        const found = element !== null;
        if (!found) allFound = false;
        
        html += `<p><strong>${id}:</strong> ${found ? 'âœ… æ‰¾åˆ°' : 'âŒ æœªæ‰¾åˆ°'}</p>`;
      });
      
      status.innerHTML = html;
      status.className = allFound ? 'debug-section success' : 'debug-section error';
    }
    
    function testSettingsButton() {
      log('æµ‹è¯•è®¾ç½®æŒ‰é’®...', 'info');
      const btn = document.getElementById('settings-btn');
      if (btn) {
        log('æ‰¾åˆ°è®¾ç½®æŒ‰é’®ï¼Œæ¨¡æ‹Ÿç‚¹å‡»', 'info');
        btn.click();
      } else {
        log('âŒ æœªæ‰¾åˆ°è®¾ç½®æŒ‰é’®', 'error');
      }
    }
    
    function testChromeAPI() {
      log('æµ‹è¯•Chrome API...', 'info');
      if (chrome && chrome.runtime && chrome.runtime.openOptionsPage) {
        log('ç›´æ¥è°ƒç”¨chrome.runtime.openOptionsPage()', 'info');
        chrome.runtime.openOptionsPage();
      } else {
        log('âŒ Chrome APIä¸å¯ç”¨', 'error');
      }
    }
    
    async function loadPopupContent() {
      log('åŠ è½½Popupå†…å®¹...', 'info');
      try {
        const response = await fetch('popup.html');
        const html = await response.text();
        
        // åˆ›å»ºä¸€ä¸ªéšè—çš„å®¹å™¨æ¥åŠ è½½popupå†…å®¹
        const container = document.createElement('div');
        container.style.display = 'none';
        container.innerHTML = html;
        document.body.appendChild(container);
        
        // åŠ è½½popup.js
        const script = document.createElement('script');
        script.src = 'popup.js';
        script.onload = () => {
          log('âœ… Popupå†…å®¹åŠ è½½å®Œæˆ', 'success');
          setTimeout(() => {
            checkDOMElements();
          }, 500);
        };
        script.onerror = () => {
          log('âŒ Popup.jsåŠ è½½å¤±è´¥', 'error');
        };
        document.head.appendChild(script);
        
      } catch (error) {
        log(`âŒ åŠ è½½å¤±è´¥: ${error.message}`, 'error');
      }
    }
    
    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      logElement = document.getElementById('log');
      log('ğŸš€ è°ƒè¯•é¡µé¢åˆå§‹åŒ–', 'info');
      
      setupChromeAPI();
      checkChromeAPI();
      checkDOMElements();
    });
  </script>
</body>
</html>
