<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>é…ç½®æµ‹è¯•é¡µé¢</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #f5f5f5;
    }
    .section {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border-left: 4px solid #4285f4;
    }
    .error { border-left-color: #d93025; }
    .success { border-left-color: #34a853; }
    .warning { border-left-color: #fbbc04; }
    button {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background: #4285f4;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #3367d6;
    }
    input {
      padding: 8px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 300px;
    }
    #log {
      background: #000;
      color: #0f0;
      padding: 10px;
      border-radius: 4px;
      height: 200px;
      overflow-y: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>ğŸ”§ é…ç½®æµ‹è¯•é¡µé¢</h1>
  
  <div class="section">
    <h3>å½“å‰é…ç½®</h3>
    <div id="current-config">åŠ è½½ä¸­...</div>
    <button onclick="loadConfig()">åˆ·æ–°é…ç½®</button>
  </div>
  
  <div class="section">
    <h3>è®¾ç½®æœåŠ¡å™¨åœ°å€</h3>
    <input type="url" id="server-url" placeholder="https://accountback.azhen.de" value="https://accountback.azhen.de">
    <button onclick="saveServerURL()">ä¿å­˜æœåŠ¡å™¨åœ°å€</button>
  </div>
  
  <div class="section">
    <h3>æµ‹è¯•ç™»å½•</h3>
    <input type="text" id="username" placeholder="ç”¨æˆ·å">
    <input type="password" id="password" placeholder="å¯†ç ">
    <button onclick="testLogin()">æµ‹è¯•ç™»å½•</button>
  </div>
  
  <div class="section">
    <h3>æ“ä½œæ—¥å¿—</h3>
    <div id="log"></div>
    <button onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
  </div>

  <script>
    let logElement;
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logLine = `[${timestamp}] ${message}`;
      console.log(logLine);
      
      if (logElement) {
        const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : type === 'warning' ? '#ff0' : '#0f0';
        logElement.innerHTML += `<div style="color: ${color}">${logLine}</div>`;
        logElement.scrollTop = logElement.scrollHeight;
      }
    }
    
    function clearLog() {
      if (logElement) {
        logElement.innerHTML = '';
      }
    }
    
    // æ¨¡æ‹ŸChrome API
    if (typeof chrome === 'undefined') {
      window.chrome = {
        storage: {
          sync: {
            get: function(keys, callback) {
              const stored = JSON.parse(localStorage.getItem('chrome-storage') || '{}');
              if (keys === null) {
                callback(stored);
              } else if (Array.isArray(keys)) {
                const result = {};
                keys.forEach(key => {
                  if (stored[key] !== undefined) {
                    result[key] = stored[key];
                  }
                });
                callback(result);
              } else {
                callback(stored[keys] ? { [keys]: stored[keys] } : {});
              }
            },
            set: function(items, callback) {
              const stored = JSON.parse(localStorage.getItem('chrome-storage') || '{}');
              Object.assign(stored, items);
              localStorage.setItem('chrome-storage', JSON.stringify(stored));
              if (callback) callback();
            }
          }
        },
        runtime: {
          sendMessage: function(message, callback) {
            log(`å‘é€æ¶ˆæ¯: ${JSON.stringify(message)}`, 'info');
            
            // æ¨¡æ‹Ÿbackground.jsçš„å“åº”
            setTimeout(() => {
              if (message.action === 'getConfig') {
                const stored = JSON.parse(localStorage.getItem('chrome-storage') || '{}');
                callback(stored);
              } else if (message.action === 'saveConfig') {
                const stored = JSON.parse(localStorage.getItem('chrome-storage') || '{}');
                Object.assign(stored, message.config);
                localStorage.setItem('chrome-storage', JSON.stringify(stored));
                callback({ success: true });
              } else if (message.action === 'login') {
                // æ¨¡æ‹Ÿç™»å½•è¯·æ±‚
                const stored = JSON.parse(localStorage.getItem('chrome-storage') || '{}');
                if (!stored.serverURL) {
                  callback({ success: false, error: 'è¯·å…ˆåœ¨è®¾ç½®ä¸­é…ç½®æœåŠ¡å™¨åœ°å€' });
                } else {
                  callback({ success: false, error: 'æ¨¡æ‹Ÿç¯å¢ƒï¼Œæ— æ³•çœŸå®ç™»å½•' });
                }
              } else {
                callback({ success: false, error: 'æœªçŸ¥æ“ä½œ' });
              }
            }, 100);
          }
        }
      };
    }
    
    async function loadConfig() {
      log('åŠ è½½é…ç½®...', 'info');
      
      chrome.storage.sync.get(null, (result) => {
        log(`é…ç½®åŠ è½½å®Œæˆ: ${JSON.stringify(result)}`, 'success');
        
        const configDiv = document.getElementById('current-config');
        if (Object.keys(result).length === 0) {
          configDiv.innerHTML = '<p style="color: #d93025;">âŒ æœªæ‰¾åˆ°ä»»ä½•é…ç½®</p>';
        } else {
          let html = '<ul>';
          for (const [key, value] of Object.entries(result)) {
            if (key === 'password') {
              html += `<li><strong>${key}:</strong> ${'*'.repeat(value.length)}</li>`;
            } else {
              html += `<li><strong>${key}:</strong> ${value}</li>`;
            }
          }
          html += '</ul>';
          configDiv.innerHTML = html;
        }
      });
    }
    
    async function saveServerURL() {
      const serverURL = document.getElementById('server-url').value;
      
      if (!serverURL) {
        log('âŒ è¯·è¾“å…¥æœåŠ¡å™¨åœ°å€', 'error');
        return;
      }
      
      try {
        new URL(serverURL);
      } catch (error) {
        log('âŒ æœåŠ¡å™¨åœ°å€æ ¼å¼ä¸æ­£ç¡®', 'error');
        return;
      }
      
      log(`ä¿å­˜æœåŠ¡å™¨åœ°å€: ${serverURL}`, 'info');
      
      chrome.runtime.sendMessage({
        action: 'saveConfig',
        config: { serverURL }
      }, (response) => {
        if (response.success) {
          log('âœ… æœåŠ¡å™¨åœ°å€ä¿å­˜æˆåŠŸ', 'success');
          loadConfig();
        } else {
          log(`âŒ ä¿å­˜å¤±è´¥: ${response.error}`, 'error');
        }
      });
    }
    
    async function testLogin() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      if (!username || !password) {
        log('âŒ è¯·è¾“å…¥ç”¨æˆ·åå’Œå¯†ç ', 'error');
        return;
      }
      
      log(`æµ‹è¯•ç™»å½•: ${username}`, 'info');
      
      chrome.runtime.sendMessage({
        action: 'login',
        username,
        password
      }, (response) => {
        if (response.success) {
          log('âœ… ç™»å½•æˆåŠŸ', 'success');
        } else {
          log(`âŒ ç™»å½•å¤±è´¥: ${response.error}`, 'error');
        }
      });
    }
    
    // é¡µé¢åˆå§‹åŒ–
    document.addEventListener('DOMContentLoaded', () => {
      logElement = document.getElementById('log');
      log('ğŸš€ é…ç½®æµ‹è¯•é¡µé¢åˆå§‹åŒ–', 'info');
      loadConfig();
    });
  </script>
</body>
</html>
