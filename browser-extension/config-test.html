<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>配置测试页面</title>
  <style>
    body {
      font-family: monospace;
      padding: 20px;
      background: #f5f5f5;
    }
    .section {
      background: white;
      padding: 15px;
      margin: 10px 0;
      border-radius: 5px;
      border-left: 4px solid #4285f4;
    }
    .error { border-left-color: #d93025; }
    .success { border-left-color: #34a853; }
    .warning { border-left-color: #fbbc04; }
    button {
      padding: 10px 15px;
      margin: 5px;
      border: none;
      border-radius: 4px;
      background: #4285f4;
      color: white;
      cursor: pointer;
    }
    button:hover {
      background: #3367d6;
    }
    input {
      padding: 8px;
      margin: 5px;
      border: 1px solid #ddd;
      border-radius: 4px;
      width: 300px;
    }
    #log {
      background: #000;
      color: #0f0;
      padding: 10px;
      border-radius: 4px;
      height: 200px;
      overflow-y: auto;
      font-size: 12px;
    }
  </style>
</head>
<body>
  <h1>🔧 配置测试页面</h1>
  
  <div class="section">
    <h3>当前配置</h3>
    <div id="current-config">加载中...</div>
    <button onclick="loadConfig()">刷新配置</button>
  </div>
  
  <div class="section">
    <h3>设置服务器地址</h3>
    <input type="url" id="server-url" placeholder="https://accountback.azhen.de" value="https://accountback.azhen.de">
    <button onclick="saveServerURL()">保存服务器地址</button>
  </div>
  
  <div class="section">
    <h3>测试登录</h3>
    <input type="text" id="username" placeholder="用户名">
    <input type="password" id="password" placeholder="密码">
    <button onclick="testLogin()">测试登录</button>
  </div>
  
  <div class="section">
    <h3>操作日志</h3>
    <div id="log"></div>
    <button onclick="clearLog()">清空日志</button>
  </div>

  <script>
    let logElement;
    
    function log(message, type = 'info') {
      const timestamp = new Date().toLocaleTimeString();
      const logLine = `[${timestamp}] ${message}`;
      console.log(logLine);
      
      if (logElement) {
        const color = type === 'error' ? '#f00' : type === 'success' ? '#0f0' : type === 'warning' ? '#ff0' : '#0f0';
        logElement.innerHTML += `<div style="color: ${color}">${logLine}</div>`;
        logElement.scrollTop = logElement.scrollHeight;
      }
    }
    
    function clearLog() {
      if (logElement) {
        logElement.innerHTML = '';
      }
    }
    
    // 模拟Chrome API
    if (typeof chrome === 'undefined') {
      window.chrome = {
        storage: {
          sync: {
            get: function(keys, callback) {
              const stored = JSON.parse(localStorage.getItem('chrome-storage') || '{}');
              if (keys === null) {
                callback(stored);
              } else if (Array.isArray(keys)) {
                const result = {};
                keys.forEach(key => {
                  if (stored[key] !== undefined) {
                    result[key] = stored[key];
                  }
                });
                callback(result);
              } else {
                callback(stored[keys] ? { [keys]: stored[keys] } : {});
              }
            },
            set: function(items, callback) {
              const stored = JSON.parse(localStorage.getItem('chrome-storage') || '{}');
              Object.assign(stored, items);
              localStorage.setItem('chrome-storage', JSON.stringify(stored));
              if (callback) callback();
            }
          }
        },
        runtime: {
          sendMessage: function(message, callback) {
            log(`发送消息: ${JSON.stringify(message)}`, 'info');
            
            // 模拟background.js的响应
            setTimeout(() => {
              if (message.action === 'getConfig') {
                const stored = JSON.parse(localStorage.getItem('chrome-storage') || '{}');
                callback(stored);
              } else if (message.action === 'saveConfig') {
                const stored = JSON.parse(localStorage.getItem('chrome-storage') || '{}');
                Object.assign(stored, message.config);
                localStorage.setItem('chrome-storage', JSON.stringify(stored));
                callback({ success: true });
              } else if (message.action === 'login') {
                // 模拟登录请求
                const stored = JSON.parse(localStorage.getItem('chrome-storage') || '{}');
                if (!stored.serverURL) {
                  callback({ success: false, error: '请先在设置中配置服务器地址' });
                } else {
                  callback({ success: false, error: '模拟环境，无法真实登录' });
                }
              } else {
                callback({ success: false, error: '未知操作' });
              }
            }, 100);
          }
        }
      };
    }
    
    async function loadConfig() {
      log('加载配置...', 'info');
      
      chrome.storage.sync.get(null, (result) => {
        log(`配置加载完成: ${JSON.stringify(result)}`, 'success');
        
        const configDiv = document.getElementById('current-config');
        if (Object.keys(result).length === 0) {
          configDiv.innerHTML = '<p style="color: #d93025;">❌ 未找到任何配置</p>';
        } else {
          let html = '<ul>';
          for (const [key, value] of Object.entries(result)) {
            if (key === 'password') {
              html += `<li><strong>${key}:</strong> ${'*'.repeat(value.length)}</li>`;
            } else {
              html += `<li><strong>${key}:</strong> ${value}</li>`;
            }
          }
          html += '</ul>';
          configDiv.innerHTML = html;
        }
      });
    }
    
    async function saveServerURL() {
      const serverURL = document.getElementById('server-url').value;
      
      if (!serverURL) {
        log('❌ 请输入服务器地址', 'error');
        return;
      }
      
      try {
        new URL(serverURL);
      } catch (error) {
        log('❌ 服务器地址格式不正确', 'error');
        return;
      }
      
      log(`保存服务器地址: ${serverURL}`, 'info');
      
      chrome.runtime.sendMessage({
        action: 'saveConfig',
        config: { serverURL }
      }, (response) => {
        if (response.success) {
          log('✅ 服务器地址保存成功', 'success');
          loadConfig();
        } else {
          log(`❌ 保存失败: ${response.error}`, 'error');
        }
      });
    }
    
    async function testLogin() {
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;
      
      if (!username || !password) {
        log('❌ 请输入用户名和密码', 'error');
        return;
      }
      
      log(`测试登录: ${username}`, 'info');
      
      chrome.runtime.sendMessage({
        action: 'login',
        username,
        password
      }, (response) => {
        if (response.success) {
          log('✅ 登录成功', 'success');
        } else {
          log(`❌ 登录失败: ${response.error}`, 'error');
        }
      });
    }
    
    // 页面初始化
    document.addEventListener('DOMContentLoaded', () => {
      logElement = document.getElementById('log');
      log('🚀 配置测试页面初始化', 'info');
      loadConfig();
    });
  </script>
</body>
</html>
